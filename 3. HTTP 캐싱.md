# HTTP 캐싱
웹 캐시는 레이턴시와 네트워크 트래픽을 줄여줌으로써 리소스를 보여주는 데에 필요한 시간을 줄여준다.

## 캐시
캐시는 주어진 리소스의 복사본을 저장하고 있다가 요청 시에 그것을 제공하는 기술이다. 웹 캐시에 요청된 리소스가 있다면, 요청을 가로채 원래의 서버로부터 리소스를 다시 다운로드하는 대신 리소스의 복사본을 반환한다. 
- 모든 클라이언트를 서비스할 필요가 없으므로 서버 부하가 완화된다.
- 클라이언트에 가까이 있으므로 성능이 향상된다.

단, 리소스는 변할 수 있으므로 리소스가 변하기 전까지만 캐싱하고 변한 이후에 더이상 캐싱하지 않는 것이 중요하다.

캐시에는 private, shared 두 가지가 있다. 공유(shared) 캐시는 한 명 이상의 사용자가 재사용할 수 있도록 응답을 저장하는 캐시이다. 사설 캐시는 한 명의 사용자만 사용하는 캐시이다. 

캐시는 브라우저 캐시, 프록시 캐시 외에도 게이크웨이 캐시, CDN, 리버스 프록시 캐시 그리고 로드 밸런서 등이 있다.

### 사설 브라우저 캐시
단일 사용자가 전용으로 사용한다. 브라우저 캐시는 사용자에 의래 HTTP를 통해 다운로드 된 모든 문서를 가지고 있다. 뒤로가기, 앞으로 가기, 저장 등을 위해 사용할 수 있다. 또, 캐시된 컨텐츠의 오프라인 브라우징을 개성시킨다.

### 공유 프록시 캐시
한 명 이상의 사용자에 의해 재사용되는 응답을 저장하는 캐시이다.

## 캐싱 제어
### Cache-control 헤더
#### 캐시하지 않음
```
Cache-Control: no-store
```
#### 캐시하지만 재검증
```
Cache-Control: no-cache
```
#### 사설 캐시, 공개 캐시
public - 응답이 어떤 캐시에 의해서든 캐시되어도 좋음
private - 단일 사용자만을 위한 것이며 공유 캐시에 의해 저장되어서는 안됨
```
Cache-Control: private
Cache-Control: public
```
#### 만료
소스가 유효하다고 판단되는 최대 시간을 나타냄. Expires보다 우선이다. 일반적으로 CSS, js 파일들이 긴 시간 동안 캐싱할 수 있다.
```
Cache-Control: max-age=31536000
```
#### 검증
오래된 리소스를 사용하기 전에 그 상태를 확인하고 만료된 리소스는 사용하지 않도록 한다. 
```
Cache-Control: must-revalidate
```

### Pragma 헤더
Cache-Control 헤더를 사용할 수 없는 HTTP/1.0 크라이언트와의 하위 호환성을 위한 경우게만 Pragma를 사용해야 한다.

## 유효성
캐시의 저장 공간은 한정되어 있으므오 주기적으로 스토리지에서 제거한다. 이 과정을 캐시 축출이라고 한다. 반면 어떤 리소스들은 서버 상에서 변경될 수 있고, 캐시가 갱신되어야 한다. 
서버는 리소스에 대한 만료 시간을 알려주고, 만료 시간 이전에는 리소스가 유효(fresh)하고, 만료 시간 이후의 리소스는 실효(stale)하다. 축출 알고리즘은 실효된 리소스보다 유효한 리소스에 특권을 부여하고 실효된 리소스는 축출되거나 무시되지 않는다. 캐시가 실효된 리소르에 대한 요청을 받을 경우, 이 리소스가 실제로 유효한지 아닌지는 확인하기 위해 If-None-Match와 함께 요청을 전달한다. 
만약 그렇다면, 서버는 요청된 리소스 본문을 전달하지 않고 304 헤더만들 돌려보내 대역폭을 아낀다.

### 유효성 검사 휴리스틱
서버에서 유효기간을 명시적으로 정하지 않으면 휴리스틱으로 유효 기간을 추정한다.
```
expirationTime = responseTime + freshnessLifetime - currentAge
```

## 캐시 검증
캐시된 문서의 만료 시간이 가까워져오면, 문서가 검증되거나 다시 불러오게 된다. 

