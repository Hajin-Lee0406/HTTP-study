# 콘텐츠 협상
HTTP에서 콘텐츠 협상은 동일한 URI에서 리소스의 서로 다른 버전을 제공하기 위해 사용하는 매커니즘으로, 사용자가 에이전트가 사용자에게 제일 잘 맞는 것이 무엇인지를 명시할 수 있다. 

## 콘텐츠 협상의 원칙
특정 문서를 리소스라고 부른다. 서버는 리소스가 제공하는 여러 변형들 중 하나를 선택하기 위해 URL을 사용하고(각각의 변형을 프레젠테이션이라고 부른다) 클라이언트에게 해당 리소스의 특정 프레젠테이션을 반환한다.
프레젠테이션의 결정에는 2개의 매커니즘이 있다.
- 클라이언트가 보내는 특정 HTTP헤더를 이용하는 방법. 특정 종류의 리소스에 대한 표준 협상 방법
- 서버에 의해 전달되는 300 (다중 선택) 또는 406 (하용되지 않음) HTTP 응답 코드를 이용하는 방법으로, 폴백 매커니즘으로써 사용된다.

## 서버 주도 콘텐츠 협상
브라우저는 HTTP 헤더를 전달한다. 서버는 그것들을 힌트로 사용해 내부 알고리즘은 클라이언트를 서브하기 위한 최선의 컨텐츠를 선택하게 된다. </br></br>
#### 관련 헤더들
- Accept, Accept-Charset, Accept-Encoding, Accept-Language

서버는 실제로 콘텐츠 협상에 있어 어떤 헤더가 사용될지 가리키기 위해 Vary 헤더를 사용하므로 캐시는 최적으로 동작한다. (참고 - [효율적인 웹 캐시 관리: Vary 헤더의 역할과 활용](https://medium.com/@jina-dev/%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9D%B8-%EC%9B%B9-%EC%BA%90%EC%8B%9C-%EA%B4%80%EB%A6%AC-vary-%ED%97%A4%EB%8D%94%EC%9D%98-%EC%97%AD%ED%95%A0%EA%B3%BC-%ED%99%9C%EC%9A%A9-d7568a123f9e)

#### 서버 주도 콘텐츠 협상의 단점
- 클라이언트 힌트가 있더라도, 서버는 브라우저의 수용 능력에 대한 완벽한 정보를 가지고 있진 않다. 클라이언트가 선택하는 리액티브 콘텐츠 협상과 다르게, 서버 선택은 항상 임의적이다.
- 클라이언트의 정보가 많음
    - 핑거프린팅: 웹사이트 방문자를 쿠키 없이 추적하는 기술. 사용자가 쿠키를 차단해도 피할 수 없다. 주로 광고에 활용됨
- 서버 구현이 좀 복잡해질 수 있다.
</br></br></br>

#### Accept 헤더
에이전트가 처리하고자 하는 미디어 리소스의 MIME 타입을 나열한다. 쉼표로 나열하고 선호도를 나타낸다.

#### Accept-CH 헤더
적합한 응답을 선택하기 위해 서버가 사용할 수 있는 설정 데이터를 나열한다. 
- DPR, Viewport-Width, Width

#### Accept-Charset 헤더
사용자 에이전트가 어떤 종류의 캐릭터 인코딩을 할 수 있는지 알림. 거의 사용하지 않음

#### Accept-Encoding 헤더
수용 가능한 컨텐츠 인코딩을 정의하고 있음. 기본값 identity는 가장 낮은 우선 순위(선언된 것이 없는 경우).

#### User-Agent 헤더
요청하는 브라우저를 식별한다. 

#### Vary 응답 헤더
서버 주도 콘텐츠 현상 과정 중에 서버에 의해 사용되는 헤더들의 목록을 나타낸다. 캐시된 응답이 특정 조건애 따라 다른 요청에서 사용될 수 있는지 여부를 결정한다. 
- 캐시 분리
    - Vary 헤더를 사용하여 서버는 클라이언트가 요청한 특정 헤더 필드에 기반해 응답을 분리하여 캐시한다. 예를 들어, Accept-Encoding 헤더에 따라 다른 응답을 생성할 때 Vary 헤더를 사용해 각각의 응답을 별도로 캐시하게 된다.
- 캐시 효율성
    - 클라이언트에 따라 다양한 헤더 값에 따라 응답이 달라질 수 있는 경우, Vary 헤더를 사용해 캐시 효율성을 높일 수 있다. 캐시가 특정 헤더 값을 기준으로 응답을 캐시함으로써 불필요한 캐시 사용을 방지한다.


## 에이전트 주도 협상
서버 주도 협상은 몇 가지 단점이 있다. 확장이 어렵다. 협상 내에서 사용하는 기능 당 한 가지 헤더가 존대해야 한다. 헤더가 많아지면 메시지 오버헤드가 늘어날 수 있다. 정확한 헤더가 많이 전송되면, 많은 HTTP 흔적과 관련된 개인정보들이 남을 수 있다.</br>
에이전트 주도 협상에서, 애매모호한 요청을 만나면 서버는 사용 가능한 대체 리소스들에 대한 링크를 포함하고 있는 페이지를 회신하게 된다. 사용자는 해당 리소스들을 표시하고 사용하려는 리소스를 선택한다. </br></br>
에이전트 주도 협상은 한계점이 존재한다. HTTP 에서는 리소스를 선택하는 페이지의 형식을 명시하고 있지 않고, 이를 자동화하는 것은 어렵다. 이 방법은 대체로 자바스크립트 리다이렉션과 특히 스크립팅에서 사용한다. 또한, 실제 자원을 가져오기 위해 추가적인 요청이 필요하고, 이는 속도 저하로 연결된다. 















</br></br></br></br></br></br></br></br></br></br>
---
- https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation
- https://m.blog.naver.com/ezpbill/221698694412
- https://inpa.tistory.com/entry/HTTP-%F0%9F%8C%90-%EC%BD%98%ED%85%90%EC%B8%A0-%ED%98%91%EC%83%81Content-Negotiation-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0
- https://medium.com/@jina-dev/%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9D%B8-%EC%9B%B9-%EC%BA%90%EC%8B%9C-%EA%B4%80%EB%A6%AC-vary-%ED%97%A4%EB%8D%94%EC%9D%98-%EC%97%AD%ED%95%A0%EA%B3%BC-%ED%99%9C%EC%9A%A9-d7568a123f9e